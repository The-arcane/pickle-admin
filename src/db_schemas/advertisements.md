-- Enum for Advertisement Type
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'ad_type') THEN
    CREATE TYPE public.ad_type AS ENUM ('web', 'mobile');
  END IF;
END $$;

-- Enum for Ad Status
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'ad_status') THEN
    CREATE TYPE public.ad_status AS ENUM ('Active', 'Offline', 'Draft');
  END IF;
END $$;


-- Table to store the different ad placement locations
CREATE TABLE IF NOT EXISTS public.advertisement_placements (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Insert initial placement options
INSERT INTO public.advertisement_placements (name)
VALUES
  ('Home Screen Banner'),
  ('Booking Confirmation Pop-up'),
  ('Profile Page Footer'),
  ('Dashboard Sidebar'),
  ('Login Page Banner'),
  ('Global Footer')
ON CONFLICT (name) DO NOTHING;


-- Main table for advertisements
CREATE TABLE IF NOT EXISTS public.advertisements (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  organisation_id BIGINT REFERENCES public.organisations(id) ON DELETE CASCADE,
  placement_id BIGINT NOT NULL REFERENCES public.advertisement_placements(id),
  name TEXT NOT NULL,
  ad_type public.ad_type NOT NULL,
  status public.ad_status NOT NULL DEFAULT 'Draft',
  image_url TEXT NOT NULL,
  link_url TEXT,
  target_segment TEXT NOT NULL DEFAULT 'all_users', -- e.g., 'all_users', 'new_users', 'role_admin'
  is_global BOOLEAN NOT NULL DEFAULT FALSE,
  impressions BIGINT NOT NULL DEFAULT 0,
  clicks BIGINT NOT NULL DEFAULT 0,
  start_date TIMESTAMPTZ,
  end_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT chk_global_or_org CHECK (is_global = TRUE OR organisation_id IS NOT NULL)
);

-- Trigger to auto-update updated_at timestamp
CREATE OR REPLACE TRIGGER set_advertisements_updated_at
BEFORE UPDATE ON public.advertisements
FOR EACH ROW
EXECUTE FUNCTION public.set_updated_at();

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_ads_organisation_id ON public.advertisements(organisation_id);
CREATE INDEX IF NOT EXISTS idx_ads_placement_id ON public.advertisements(placement_id);
CREATE INDEX IF NOT EXISTS idx_ads_status ON public.advertisements(status);
CREATE INDEX IF NOT EXISTS idx_ads_is_global ON public.advertisements(is_global);


-- === Row Level Security (RLS) for Advertisements ===
ALTER TABLE public.advertisements ENABLE ROW LEVEL SECURITY;

-- Super Admins can do anything
CREATE POLICY "advertisements_all_super_admins"
ON public.advertisements FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM public."user" u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3
  )
);

-- Organization admins can view their own ads AND global ads
CREATE POLICY "advertisements_select_org_admins"
ON public.advertisements FOR SELECT
USING (
  is_global = TRUE
  OR
  EXISTS (
    SELECT 1
    FROM public.user_organisations uo
    JOIN public."user" u ON uo.user_id = u.id
    WHERE u.user_uuid = auth.uid()
      AND uo.organisation_id = advertisements.organisation_id
  )
);

-- Organization admins can only create/update/delete ads for THEIR organization
CREATE POLICY "advertisements_write_org_admins"
ON public.advertisements FOR ALL
USING (
  EXISTS (
    SELECT 1
    FROM public.user_organisations uo
    JOIN public."user" u ON uo.user_id = u.id
    WHERE u.user_uuid = auth.uid()
      AND uo.organisation_id = advertisements.organisation_id
  )
)
WITH CHECK (
  is_global = FALSE -- Org admins cannot create global ads
  AND
  EXISTS (
    SELECT 1
    FROM public.user_organisations uo
    JOIN public."user" u ON uo.user_id = u.id
    WHERE u.user_uuid = auth.uid()
      AND uo.organisation_id = advertisements.organisation_id
  )
);


-- === RLS for Placements (read-only for authenticated users) ===
ALTER TABLE public.advertisement_placements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "advertisement_placements_select_authenticated"
ON public.advertisement_placements FOR SELECT
USING (auth.role() = 'authenticated');
