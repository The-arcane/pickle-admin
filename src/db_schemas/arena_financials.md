# Arena Financials - Supabase Table Schemas

This document provides the SQL scripts to create the necessary tables for the financial features in the Arena admin panel.

---

## 1. Bank Details

This table stores the bank account information for an organization where payouts will be sent. Each organization should have only one set of bank details.

**Table Name:** `arena_bank_details`

```sql
CREATE TABLE public.arena_bank_details (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organisation_id BIGINT NOT NULL UNIQUE REFERENCES public.organisations(id) ON DELETE CASCADE,
    bank_name TEXT NOT NULL,
    account_holder_name TEXT NOT NULL,
    account_number_encrypted TEXT NOT NULL, -- Encrypted account number
    ifsc_code TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS Policy: Allow Arena admins to manage their own bank details
CREATE POLICY "Allow Arena admins to manage their own bank details"
ON public.arena_bank_details
FOR ALL
USING (
    organisation_id IN (
        SELECT organisation_id
        FROM public.user_organisations
        WHERE user_id = (
            SELECT id FROM public.user WHERE user_uuid = auth.uid()
        )
    )
);

-- Enable RLS
ALTER TABLE public.arena_bank_details ENABLE ROW LEVEL SECURITY;
```

**Security Note:** The `account_number` should be encrypted at rest. Supabase provides the `pgsodium` extension for this. The column `account_number_encrypted` is used to store this encrypted value. You will need to handle encryption and decryption within your application logic or via database functions.

---

## 2. Payouts (Transfers)

This table tracks the payouts/transfers made from the platform to the organization's bank account.

**Table Name:** `payouts`

```sql
CREATE TYPE payout_status AS ENUM ('Pending', 'Completed', 'Failed');

CREATE TABLE public.payouts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organisation_id BIGINT NOT NULL REFERENCES public.organisations(id) ON DELETE CASCADE,
    amount NUMERIC(10, 2) NOT NULL,
    status payout_status NOT NULL DEFAULT 'Pending',
    requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMPTZ,
    bank_transaction_id TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS Policy: Allow admins to view their own organization's payouts
CREATE POLICY "Allow admins to view their organization's payouts"
ON public.payouts
FOR SELECT
USING (
    organisation_id IN (
        SELECT organisation_id
        FROM public.user_organisations
        WHERE user_id = (
            SELECT id FROM public.user WHERE user_uuid = auth.uid()
        )
    )
);

-- Enable RLS
ALTER TABLE public.payouts ENABLE ROW LEVEL SECURITY;
```

---

## 3. Transactions

A general ledger of all financial movements (credits and debits) related to an organization.

**Table Name:** `transactions`

```sql
CREATE TYPE transaction_type AS ENUM ('Credit', 'Debit');
CREATE TYPE transaction_category AS ENUM ('Booking Fee', 'Event Fee', 'Payout', 'Refund', 'Platform Fee', 'Other');

CREATE TABLE public.transactions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organisation_id BIGINT NOT NULL REFERENCES public.organisations(id) ON DELETE CASCADE,
    type transaction_type NOT NULL,
    category transaction_category NOT NULL,
    amount NUMERIC(10, 2) NOT NULL,
    description TEXT NOT NULL,
    related_booking_id BIGINT REFERENCES public.bookings(id) ON DELETE SET NULL,
    related_event_booking_id BIGINT REFERENCES public.event_bookings(id) ON DELETE SET NULL,
    related_payout_id BIGINT REFERENCES public.payouts(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS Policy: Allow admins to view their own organization's transactions
CREATE POLICY "Allow admins to view their organization's transactions"
ON public.transactions
FOR SELECT
USING (
    organisation_id IN (
        SELECT organisation_id
        FROM public.user_organisations
        WHERE user_id = (
            SELECT id FROM public.user WHERE user_uuid = auth.uid()
        )
    )
);

-- Enable RLS
ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;
```

---

## 4. Invoices

This table stores records of invoices generated for bookings, events, etc.

**Table Name:** `invoices`

```sql
CREATE TYPE invoice_status AS ENUM ('Draft', 'Sent', 'Paid', 'Pending', 'Overdue', 'Cancelled');

CREATE TABLE public.invoices (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organisation_id BIGINT NOT NULL REFERENCES public.organisations(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES public.user(id) ON DELETE CASCADE,
    status invoice_status NOT NULL DEFAULT 'Draft',
    total_amount NUMERIC(10, 2) NOT NULL,
    issue_date DATE NOT NULL DEFAULT CURRENT_DATE,
    due_date DATE NOT NULL,
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE public.invoice_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    invoice_id BIGINT NOT NULL REFERENCES public.invoices(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    unit_price NUMERIC(10, 2) NOT NULL,
    total_price NUMERIC(10, 2) GENERATED ALWAYS AS (quantity * unit_price) STORED
);


-- RLS Policy: Allow admins to view their organization's invoices
CREATE POLICY "Allow admins to view their organization's invoices"
ON public.invoices
FOR SELECT
USING (
    organisation_id IN (
        SELECT organisation_id
        FROM public.user_organisations
        WHERE user_id = (
            SELECT id FROM public.user WHERE user_uuid = auth.uid()
        )
    )
);

-- Enable RLS for both tables
ALTER TABLE public.invoices ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.invoice_items ENABLE ROW LEVEL SECURITY;
```

You can run these scripts in the Supabase SQL Editor to set up the necessary tables for your Arena financial features.
