
-- Create enum types for ticket status and priority
DO $$ BEGIN
    CREATE TYPE public.ticket_status AS ENUM ('Open', 'In Progress', 'Closed');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE public.ticket_priority AS ENUM ('Low', 'Medium', 'High');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Table to store support tickets
CREATE TABLE IF NOT EXISTS public.tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.user(id) ON DELETE CASCADE,
    organisation_id BIGINT NOT NULL REFERENCES public.organisations(id) ON DELETE CASCADE,
    subject TEXT NOT NULL,
    description TEXT,
    status public.ticket_status NOT NULL DEFAULT 'Open',
    priority public.ticket_priority NOT NULL DEFAULT 'Medium',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    resolved_at TIMESTAMPTZ
);

-- Trigger to auto-update the 'updated_at' timestamp
CREATE OR REPLACE TRIGGER set_tickets_updated_at
BEFORE UPDATE ON public.tickets
FOR EACH ROW
EXECUTE FUNCTION public.set_updated_at(); -- Reusing the function from arena_financials

-- RLS policies for tickets
ALTER TABLE public.tickets ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tickets are visible to the user who created them"
ON public.tickets FOR SELECT
USING (auth.uid() = (SELECT user_uuid FROM public.user WHERE id = user_id));

CREATE POLICY "Users can create their own tickets"
ON public.tickets FOR INSERT
WITH CHECK (auth.uid() = (SELECT user_uuid FROM public.user WHERE id = user_id));

CREATE POLICY "Org admins can view all tickets for their org"
ON public.tickets FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM public.user_organisations uo
    JOIN public.user u ON uo.user_id = u.id
    WHERE u.user_uuid = auth.uid() AND uo.organisation_id = tickets.organisation_id
  )
);

CREATE POLICY "Super admins can manage all tickets"
ON public.tickets FOR ALL
USING (EXISTS (
    SELECT 1 FROM public.user u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3 -- 3 is Super Admin
));


-- Table to store messages within a ticket
CREATE TABLE IF NOT EXISTS public.ticket_messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ticket_id BIGINT NOT NULL REFERENCES public.tickets(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES public.user(id) ON DELETE CASCADE,
    message TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS policies for ticket messages
ALTER TABLE public.ticket_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Messages are visible to participants of the ticket"
ON public.ticket_messages FOR SELECT
USING (
    -- User who created the ticket
    auth.uid() = (SELECT user_uuid FROM public.user WHERE id = (SELECT user_id FROM public.tickets WHERE id = ticket_id))
    -- Or an admin of the ticket's organization
    OR EXISTS (
        SELECT 1 FROM public.user_organisations uo
        JOIN public.user u ON uo.user_id = u.id
        WHERE u.user_uuid = auth.uid() AND uo.organisation_id = (SELECT organisation_id FROM public.tickets WHERE id = ticket_id)
    )
);

CREATE POLICY "Users can add messages to their own tickets"
ON public.ticket_messages FOR INSERT
WITH CHECK (
    auth.uid() = (SELECT user_uuid FROM public.user WHERE id = user_id)
);

CREATE POLICY "Admins can add messages to tickets in their org"
ON public.ticket_messages FOR INSERT
WITH CHECK (
    EXISTS (
        SELECT 1 FROM public.user_organisations uo
        JOIN public.user u ON uo.user_id = u.id
        WHERE u.user_uuid = auth.uid() AND uo.organisation_id = (SELECT organisation_id FROM public.tickets WHERE id = ticket_id)
    )
);

CREATE POLICY "Super admins can manage all ticket messages"
ON public.ticket_messages FOR ALL
USING (EXISTS (
    SELECT 1 FROM public.user u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3 -- 3 is Super Admin
));
