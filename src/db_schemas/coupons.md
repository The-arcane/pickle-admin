-- Enum for discount type
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'discount_type') THEN
    CREATE TYPE public.discount_type AS ENUM ('percentage', 'fixed');
  END IF;
END $$;

-- Main table for coupons
CREATE TABLE IF NOT EXISTS public.coupons (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  organisation_id BIGINT REFERENCES public.organisations(id) ON DELETE CASCADE, -- Link to an organization, can be NULL for global coupons
  code TEXT NOT NULL UNIQUE,
  description TEXT,
  discount_type public.discount_type NOT NULL,
  discount_value NUMERIC(10, 2) NOT NULL CHECK (discount_value > 0),
  max_discount_amount NUMERIC(10, 2) CHECK (max_discount_amount > 0),
  min_booking_value NUMERIC(10, 2),
  min_slots INTEGER,
  valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  valid_until TIMESTAMPTZ,
  max_usage_count INT,
  current_usage_count INT NOT NULL DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Join table for coupon-to-court mapping
CREATE TABLE IF NOT EXISTS public.coupon_courts (
  coupon_id BIGINT NOT NULL REFERENCES public.coupons(id) ON DELETE CASCADE,
  court_id BIGINT NOT NULL REFERENCES public.courts(id) ON DELETE CASCADE,
  PRIMARY KEY (coupon_id, court_id)
);

-- Join table for coupon-to-event mapping
CREATE TABLE IF NOT EXISTS public.coupon_events (
  coupon_id BIGINT NOT NULL REFERENCES public.coupons(id) ON DELETE CASCADE,
  event_id BIGINT NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
  PRIMARY KEY (coupon_id, event_id)
);

-- Trigger to auto-update updated_at timestamp
CREATE OR REPLACE TRIGGER set_coupons_updated_at
BEFORE UPDATE ON public.coupons
FOR EACH ROW
EXECUTE FUNCTION public.set_updated_at();

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_coupons_code ON public.coupons(code);
CREATE INDEX IF NOT EXISTS idx_coupons_organisation_id ON public.coupons(organisation_id);
CREATE INDEX IF NOT EXISTS idx_coupons_is_active_and_valid_until ON public.coupons(is_active, valid_until);
CREATE INDEX IF NOT EXISTS idx_coupon_courts_coupon_id ON public.coupon_courts(coupon_id);
CREATE INDEX IF NOT EXISTS idx_coupon_events_coupon_id ON public.coupon_events(coupon_id);

-- RLS Policies
ALTER TABLE public.coupons ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.coupon_courts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.coupon_events ENABLE ROW LEVEL SECURITY;

-- Super Admins can manage all coupons and their links
CREATE POLICY "coupons_all_super_admins"
ON public.coupons FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM public."user" u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3
  )
);

CREATE POLICY "coupon_courts_all_super_admins"
ON public.coupon_courts FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM public."user" u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3
  )
);

CREATE POLICY "coupon_events_all_super_admins"
ON public.coupon_events FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM public."user" u
    WHERE u.user_uuid = auth.uid() AND u.user_type = 3
  )
);

-- Allow authenticated users to read active coupons
CREATE POLICY "coupons_select_authenticated"
ON public.coupons FOR SELECT
USING (auth.role() = 'authenticated' AND is_active = TRUE AND (valid_until IS NULL OR valid_until > NOW()));
